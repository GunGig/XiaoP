<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>最终章：整合所有功能到 mian.py</title>
    <style>
        /* CSS Reset and Basic Styles */
        body, h1, h2, h3, h4, p, pre, code, ul, li, div {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            line-height: 1.8;
            background-color: #f0f2f5;
            color: #333;
            padding: 20px;
        }

        /* Main Container */
        .container {
            max-width: 900px;
            margin: 20px auto;
            background-color: #ffffff;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            padding: 30px 40px;
            border: 1px solid #e8e8e8;
        }

        /* Headings */
        h1 {
            color: #2c3e50;
            font-size: 2.4em;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .intro {
            font-size: 1.1em;
            color: #555;
            text-align: center;
            margin-bottom: 40px;
            border-bottom: 2px solid #8e44ad;
            padding-bottom: 20px;
        }

        /* Level Card Style */
        .level-card {
            background-color: #ffffff;
            border: 1px solid #ddd;
            border-radius: 12px;
            padding: 25px;
            margin-top: 30px;
            transition: all 0.3s ease-in-out;
            border-left: 5px solid #8e44ad;
        }

        .level-card h2 {
            color: #8e44ad;
            font-size: 2em;
            margin-bottom: 20px;
        }
        
        h3 {
            color: #16a085;
            margin-top: 25px;
            margin-bottom: 10px;
            font-size: 1.5em;
        }

        .objective {
            font-style: italic;
            color: #7f8c8d;
            margin-bottom: 20px;
            padding: 10px 15px;
            background: #ecf0f1;
            border-radius: 6px;
            border-left: 3px solid #7f8c8d;
        }

        /* Code Blocks */
        pre {
            background-color: #282c34;
            color: #abb2bf;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            line-height: 1.6;
        }
        pre code {
            font-family: "Fira Code", "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace;
            font-size: 0.95em;
        }
        
        /* Analysis & Example Sections */
        .analysis {
            margin-top: 20px;
            padding: 15px;
            background: #fdfdfd;
            border: 1px dashed #ccc;
            border-radius: 8px;
        }
        .analysis h4 {
            color: #27ae60;
            margin-bottom: 10px;
        }
        .analysis ul { list-style-position: inside; padding-left: 10px; }
        .analysis li { margin-bottom: 8px; }
        .analysis code {
            background-color: #e8e8e8;
            color: #c0392b;
            padding: 2px 5px;
            border-radius: 4px;
        }

        /* Quiz Section */
        .quiz-section {
            margin-top: 25px;
            padding: 20px;
            background-color: #f5eef8;
            border: 1px solid #e8daef;
            border-radius: 8px;
        }
        .quiz-section h4 { color: #8e44ad; }
        .quiz-options div { margin: 10px 0; }
        .quiz-options label { margin-left: 8px; cursor: pointer; }
        .feedback {
            margin-top: 10px;
            font-weight: bold;
            padding: 8px;
            border-radius: 4px;
            display: none;
        }
        .feedback.correct { color: #27ae60; background-color: #e8f5e9; }
        .feedback.incorrect { color: #c0392b; background-color: #fbe9e7; }

        /* Buttons */
        .quiz-submit-btn, .unlock-btn {
            display: inline-block;
            margin-top: 15px;
            padding: 10px 20px;
            font-size: 1.05em;
            font-weight: bold;
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .quiz-submit-btn { background-color: #9b59b6; }
        .quiz-submit-btn:hover { background-color: #8e44ad; }
        .unlock-btn { background: linear-gradient(90deg, #9b59b6, #8e44ad); }
        .unlock-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(142, 68, 173, 0.4); }
        .unlock-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .hidden { display: none; }
    </style>
</head>
<body>

    <div class="container">
        <h1>最终章：整合所有功能到 `mian.py`</h1>
        <p class="intro">
            欢迎来到最后的挑战！我们已经制作好了“记事本”、“故事大王”、“随机魔法”和“知识库”等强大模块。现在，是时候把这些零件组装起来，让我们的小P助手真正变得完整和强大！
        </p>

        <!-- Level 1: Robust Import -->
        <div id="level-1" class="level-card">
            <h2>关卡 1：开启时空之门 (健壮的模块导入)</h2>
            <p class="objective">学习目标：学会使用 `try...except ImportError` 来安全地导入模块，即使某个模块文件丢失，程序也能继续运行而不会崩溃。</p>
            
            <h3>在 `mian.py` 中新增的导入代码</h3>
            <pre><code># 新增导入
try:
    import random_magic.magic_handler
    magic_module_found = True
except ImportError:
    print("警告：未能找到 '随机魔法' 模块...")
    magic_module_found = False

try:
    import local_kb.kb_handler
    kb_module_found = True
except ImportError:
    print("警告：未能找到 '本地知识库' 模块...")
    kb_module_found = False</code></pre>

            <div class="analysis">
                <h4>💡 代码解读</h4>
                <ul>
                    <li><code>try:</code> Python会尝试执行这下面的代码。</li>
                    <li><code>import random_magic.magic_handler</code>: 这就是导入我们之前写的模块！它的意思是“从 `random_magic` 文件夹中，导入 `magic_handler.py` 文件”。</li>
                    <li><code>magic_module_found = True</code>: 如果导入成功，我们就设置一个“标志”变量为 `True`，表示这个功能可用。</li>
                    <li><code>except ImportError:</code> 如果 `try` 块中的导入失败了（比如文件不存在或路径错误），程序不会崩溃，而是会跳转到这里来执行。</li>
                    <li><code>magic_module_found = False</code>: 在导入失败时，我们把标志变量设为 `False`。</li>
                </ul>
            </div>
            
            <div class="quiz-section">
                <h4>🧠 小测验</h4>
                <p>使用 `try...except ImportError` 结构导入模块，最大的好处是什么？</p>
                <div class="quiz-options">
                    <div><input type="radio" id="q1a" name="quiz1" value="a"><label for="q1a">让模块加载得更快。</label></div>
                    <div><input type="radio" id="q1b" name="quiz1" value="b" data-correct="true"><label for="q1b">即使某个模块文件丢失，主程序也能继续运行，只是部分功能不可用。</label></div>
                    <div><input type="radio" id="q1c" name="quiz1" value="c"><label for="q1c">自动修复丢失的模块文件。</label></div>
                </div>
                <button class="quiz-submit-btn" data-level="1">提交答案</button>
                <p class="feedback" id="feedback-1"></p>
            </div>
            
            <button class="unlock-btn" data-unlock="level-2" disabled>我理解了，下一关！</button>
        </div>

        <!-- Level 2: Conditional Greeting -->
        <div id="level-2" class="level-card hidden">
            <h2>关卡 2：动态功能菜单 (条件判断)</h2>
            <p class="objective">学习目标：利用上一关设置的标志位，让小P的自我介绍能根据当前可用的功能动态变化。</p>

            <h3>更新小P的自我介绍</h3>
            <pre><code># ...
if magic_module_found:
    print(f"输入 '随机魔法' 或 '魔法' 可以让我帮你做选择或玩游戏。")
if kb_module_found:
    print(f"输入 '知识库' 或 '问问题' 可以考考我的知识，或者直接问我问题！")
# ...</code></pre>

            <div class="analysis">
                <h4>💡 代码解读</h4>
                <ul>
                    <li><code>if magic_module_found:</code> 这行代码的意思是：“如果 `magic_module_found` 这个标志是真的（`True`），那么就执行下面的打印语句。”</li>
                    <li>这确保了只有当“随机魔法”模块成功导入时，小P才会告诉用户它有这个功能。如果模块导入失败（标志为`False`），这条介绍就不会显示。</li>
                    <li>这让我们的程序变得非常智能和用户友好！</li>
                </ul>
            </div>
            
            <div class="quiz-section">
                <h4>🧠 小测验</h4>
                <p>如果在你的项目中，不小心删除了 `random_magic` 文件夹，那么启动 `mian.py` 后，小P的自我介绍中会包含“输入 '随机魔法'...”这句话吗？</p>
                <div class="quiz-options">
                    <div><input type="radio" id="q2a" name="quiz2" value="a"><label for="q2a">会，因为代码是写死的。</label></div>
                    <div><input type="radio" id="q2b" name="quiz2" value="b" data-correct="true"><label for="q2b">不会，因为 `magic_module_found` 会是 `False`，`if` 判断不通过。</label></div>
                    <div><input type="radio" id="q2c" name="quiz2" value="c"><label for="q2c">程序会直接崩溃，无法运行。</label></div>
                </div>
                <button class="quiz-submit-btn" data-level="2">提交答案</button>
                <p class="feedback" id="feedback-2"></p>
            </div>
            
            <button class="unlock-btn" data-unlock="level-3" disabled>动态菜单，Get！</button>
        </div>
        
        <!-- Level 3: Function Integration -->
        <div id="level-3" class="level-card hidden">
            <h2>关卡 3：功能接入主循环 (`elif`)</h2>
            <p class="objective">学习目标：在主循环中添加新的 `elif` 分支，以便在用户输入特定关键词时，能够正确调用相应模块中的函数。</p>
            
            <h3>在主循环中添加代码</h3>
            <pre><code># ...
elif ("随机魔法" in user_input or "魔法" in user_input) and magic_module_found:
    print(f"小P：好的，准备好见证奇迹了吗？...")
    random_magic.magic_handler.run_random_magic_menu()

elif ("知识库" == user_input.lower() or "教你" in user_input) and kb_module_found:
    print(f"小P：好的，我们来探索一下我的知识库吧！")
    local_kb.kb_handler.run_knowledge_menu()
# ...</code></pre>
            
            <div class="analysis">
                <h4>💡 代码解读</h4>
                <ul>
                    <li><code>elif ("随机魔法" in user_input ...):</code> 我们通过 `in` 关键字检查用户的输入是否包含“随机魔法”或“魔法”这样的关键词。</li>
                    <li><code>and magic_module_found</code>: 再次使用标志位，确保只有模块存在时才尝试调用，这是双重保险！</li>
                    <li><code>random_magic.magic_handler.run_random_magic_menu()</code>: 这是最关键的调用语句！它的结构是 **`文件夹名.文件名.函数名()`**。这就像在现实生活中告诉某人：“去‘随机魔法’这个部门，找‘魔法处理器’这个人，让他执行‘运行魔法菜单’这个任务。”</li>
                </ul>
            </div>
            
            <div class="quiz-section">
                <h4>🧠 小测验</h4>
                <p>假设在 `local_kb` 文件夹的 `kb_handler.py` 文件中有一个名为 `show_all()` 的函数，正确的调用方式是什么？</p>
                <div class="quiz-options">
                    <div><input type="radio" id="q3a" name="quiz3" value="a"><label for="q3a"><code>show_all()</code></label></div>
                    <div><input type="radio" id="q3b" name="quiz3" value="b"><label for="q3b"><code>kb_handler.show_all()</code></label></div>
                    <div><input type="radio" id="q3c" name="quiz3" value="c" data-correct="true"><label for="q3c"><code>local_kb.kb_handler.show_all()</code></label></div>
                </div>
                <button class="quiz-submit-btn" data-level="3">提交答案</button>
                <p class="feedback" id="feedback-3"></p>
            </div>

            <button class="unlock-btn" data-unlock="level-4" disabled>模块调用，学会了！</button>
        </div>
        
        <!-- Level 4: Smart Default -->
        <div id="level-4" class="level-card hidden">
            <h2>关卡 4：智能大脑 (增强默认回复)</h2>
            <p class="objective">学习目标：改造最终的 `else` 模块，让小P在不知道如何回答时，能先去自己的“知识库”里查一查，而不是立即放弃。</p>

            <h3>改造 `else` 逻辑</h3>
            <pre><code># ... (前面的elif都判断完后)
else: # 默认回复逻辑
    found_answer = False
    # ... 先检查简单回复和你好
    
    # 在给出随机回复前，先查知识库！
    if not found_answer and kb_module_found:
        kb_answer = local_kb.kb_handler.query_knowledge_base(user_input)
        if kb_answer:
            print(f"小P：{kb_answer}")
            found_answer = True
    
    # 如果所有方法都试过了，还是没找到答案
    if not found_answer:
        # ... 才给出随机的默认回复
        print(f"小P：{random.choice(default_responses)}")</code></pre>
        
            <div class="analysis">
                <h4>💡 代码解读：让小P更智能</h4>
                <p>这部分代码是小P智能化的关键一步。当用户输入一个不属于任何命令（如“记事本”、“讲故事”）的普通句子时：</p>
                <ol>
                    <li>程序不再立刻说“我不知道”。</li>
                    <li>它会先把用户的这句话，作为问题，传递给我们的 `query_knowledge_base` 函数，去知识库里搜索答案。</li>
                    <li>**如果**在知识库里找到了答案 (`if kb_answer:`)，就回答它。</li>
                    <li>**只有当**知识库里也找不到答案时 (`if not found_answer:`)，它才会像以前一样，随机选择一个“我不知道”类型的回复。</li>
                </ol>
                <p>这让小P的对话能力大大增强了！</p>
            </div>

            <div class="quiz-section">
                <h4>🧠 小测验</h4>
                <p>根据上面改造后的逻辑，如果用户输入了一个小P不认识，但知识库里恰好有答案的问题，小P会怎么做？</p>
                <div class="quiz-options">
                    <div><input type="radio" id="q4a" name="quiz4" value="a" data-correct="true"><label for="q4a">回答知识库里找到的答案。</label></div>
                    <div><input type="radio" id="q4b" name="quiz4" value="b"><label for="q4b">回答“嗯...你说的这个我还在学习中呢。”</label></div>
                    <div><input type="radio" id="q4c" name="quiz4" value="c"><label for="q4c">提示用户输入“知识库”来查询。</label></div>
                </div>
                <button class="quiz-submit-btn" data-level="4">提交答案</button>
                <p class="feedback" id="feedback-4"></p>
            </div>

            <button class="unlock-btn" data-unlock="final-challenge" disabled>我已全部通关！查看最终代码！</button>
        </div>

        <!-- Final Code -->
        <div id="final-challenge" class="level-card hidden">
            <h2>🏆 终极挑战：完整的小P主程序 🏆</h2>
            <p class="objective">太了不起了！你已经完成了所有的整合工作。现在，你的 `mian.py` 成为了一个真正的“指挥中心”，能够调度所有功能模块。下面是完整的代码，复制它，运行它，见证你亲手创造的、功能完备的AI助手——小P！</p>
            <div style="position: relative;">
                <button id="copy-button" style="position: absolute; top: 15px; right: 15px; background-color: #9b59b6; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; opacity: 0.9; transition: all 0.3s ease;">一键复制</button>
                <pre><code id="python-code"># mian.py
# creator：XianSong_Lin
# Time in 2025/6/5 15:27

# 导入我们自己的模块
# 注意：这里的导入路径是基于 mian.py 在 XiaoP 根目录，
# 并且模块文件夹也在 XiaoP 根目录。
try:
    # 你的现有导入，确保它们能正常工作
    import 小P的超级记事本.jishiben # 如果 jishiben.py 在 XiaoP/小P的超级记事本/ 目录下
    notepad_module_found = True
except ImportError:
    print("警告：未能找到 '记事本' 模块 (小P的超级记事本.jishiben)。")
    notepad_module_found = False

try:
    import 小P是故事大王.gushidawang as gushi # 如果 gushidawang.py 在 XiaoP/小P是故事大王/ 目录下
    story_module_found = True
except ImportError:
    print("警告：未能找到 '故事大王' 模块 (小P是故事大王.gushidawang)。")
    story_module_found = False

# 新增导入
try:
    import random_magic.magic_handler # 从 XiaoP/random_magic/ 目录导入 magic_handler.py
    magic_module_found = True
except ImportError:
    print("警告：未能找到 '随机魔法' 模块 (random_magic.magic_handler)。该功能可能不可用。")
    magic_module_found = False

try:
    import local_kb.kb_handler # 从 XiaoP/local_kb/ 目录导入 kb_handler.py
    kb_module_found = True
except ImportError:
    print("警告：未能找到 '本地知识库' 模块 (local_kb.kb_handler)。该功能可能不可用。")
    kb_module_found = False

# 1. 给我们的小P起个名字
my_ai_name = "小P助手"

# 2. 小P做自我介绍 (更新)
print(f"你好！我是{my_ai_name}。很高兴认识你！")
print(f"你可以对我说 '你好'。")
if notepad_module_found:
    print(f"输入 '记事本' 可以使用我的记事本功能。")
if story_module_found:
    print(f"输入 '讲故事' 或 '吹牛' 可以听我讲故事。")
if magic_module_found:
    print(f"输入 '随机魔法' 或 '魔法' 可以让我帮你做选择或玩游戏。")
if kb_module_found:
    print(f"输入 '知识库' 或 '问问题' 可以考考我的知识，或者直接问我问题！")
print(f"输入 '退出' 或 '再见' 就可以结束聊天。")


# 4. 准备一些小P能听懂的话和回答
responses = {
    "你好呀": "你好你好！今天天气真不错！",
    "你叫什么名字": f"我叫{my_ai_name}，很高兴为你服务！",
}

# 5. 创建一个主循环
while True:
    user_input = input("\n你：").strip()

    if user_input.lower() in ["退出", "再见", "bye", "exit"]:
        print(f"小P：好的，下次再聊！拜拜！")
        break

    elif "记事本" in user_input and notepad_module_found:
        print(f"小P：好的，正在为你打开记事本功能...")
        小P的超级记事本.jishiben.run_notepad() # 注意这里的调用方式
        print(f"\n小P：记事本已关闭。我们继续聊天吧！")
    
    elif ("吹牛" in user_input or "讲故事" in user_input) and story_module_found:
        print(f"小P：好的，准备听我大显身手吧！")
        gushi.tell_a_story() # 注意这里的调用方式 (gushi 是 as gushi 的别名)
        print(f"\n小P：故事讲完啦！我们继续聊天吧！")

    elif ("随机魔法" in user_input or "魔法" in user_input) and magic_module_found:
        print(f"小P：好的，准备好见证奇迹了吗？进入随机魔法屋！")
        random_magic.magic_handler.run_random_magic_menu() # 调用新模块的函数
        print(f"\n小P：魔法时间结束。我们继续聊天吧！")
    
    elif ("知识库" == user_input.lower() or "教你" in user_input or "问问题" in user_input and "知识库" not in user_input) and kb_module_found: # 调整了条件，允许“问问题”直接触发
        if "教你" in user_input or "知识库" == user_input.lower() : # 特定指令进入知识库菜单
            print(f"小P：好的，我们来探索一下我的知识库吧！")
            local_kb.kb_handler.run_knowledge_menu()
            print(f"\n小P：知识库互动结束。还有其他想聊的吗？")
        else: # 直接问问题，不进入菜单
            kb_answer = local_kb.kb_handler.query_knowledge_base(user_input)
            if kb_answer:
                print(f"小P：{kb_answer}")
            else:
                print("小P：嗯...我对这个还不太了解。你可以试试通过输入“知识库”然后选择“教小P”来教我哦！")

    else: # 默认回复逻辑
        found_answer = False
        if user_input.lower() in responses:
            print(f"小P：{responses[user_input.lower()]}")
            found_answer = True
        elif "你好" in user_input.lower():
            print("小P：你好呀！很高兴认识你！")
            found_answer = True
        
        if not found_answer and kb_module_found and "知识库" not in user_input and "教你" not in user_input: # 避免重复查询
            kb_answer = local_kb.kb_handler.query_knowledge_base(user_input)
            if kb_answer:
                print(f"小P：{kb_answer}")
                found_answer = True
        
        if not found_answer:
            # 确保 random 模块已导入
            import random 
            default_responses = [
                "嗯...你说的这个我还在学习中呢。",
                "这个问题有点深奥，我得回去查查书！",
                "你可以试试问我“你会做什么”，或者通过输入“知识库”然后选择“教小P”来教我一些新东西哦！",
                "我对这个还不太了解，能换个话题吗？"
            ]
            print(f"小P：{random.choice(default_responses)}")
</code></pre>
            </div>
        </div>

    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Quiz and Unlock Logic ---
        const quizButtons = document.querySelectorAll('.quiz-submit-btn');
        quizButtons.forEach(button => {
            button.addEventListener('click', () => {
                const level = button.dataset.level;
                const quizForm = button.closest('.quiz-section');
                const selectedOption = quizForm.querySelector(`input[name="quiz${level}"]:checked`);
                const feedbackEl = document.getElementById(`feedback-${level}`);
                
                if (!selectedOption) {
                    feedbackEl.textContent = "请先选择一个答案！";
                    feedbackEl.className = 'feedback incorrect';
                    feedbackEl.style.display = 'block';
                    return;
                }

                const isCorrect = selectedOption.hasAttribute('data-correct');
                if (isCorrect) {
                    feedbackEl.textContent = "回答正确！太棒了！🎉";
                    feedbackEl.className = 'feedback correct';
                    
                    const levelCard = button.closest('.level-card');
                    const unlockButton = levelCard.querySelector('.unlock-btn');
                    unlockButton.disabled = false;
                    
                    quizForm.querySelectorAll('input, button').forEach(el => el.disabled = true);
                } else {
                    feedbackEl.textContent = "答案不对哦，再想想？🤔";
                    feedbackEl.className = 'feedback incorrect';
                }
                feedbackEl.style.display = 'block';
            });
        });

        // --- Unlock Button Logic ---
        const unlockButtons = document.querySelectorAll('.unlock-btn');
        unlockButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                if (button.disabled) return;
                const targetId = button.getAttribute('data-unlock');
                const nextLevel = document.getElementById(targetId);

                if (nextLevel) {
                    nextLevel.classList.remove('hidden');
                    nextLevel.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    e.target.textContent = '已完成 ✔️';
                }
            });
        });

        // --- Copy Button Logic ---
        const copyButton = document.getElementById('copy-button');
        if (copyButton) {
            const codeBlock = document.getElementById('python-code');
            copyButton.addEventListener('click', () => {
                navigator.clipboard.writeText(codeBlock.innerText).then(() => {
                    copyButton.textContent = '已复制!';
                    copyButton.style.backgroundColor = '#2ecc71';
                    setTimeout(() => {
                        copyButton.textContent = '一键复制';
                        copyButton.style.backgroundColor = '#9b59b6';
                    }, 2000);
                });
            });
        }
    });
    </script>

</body>
</html>